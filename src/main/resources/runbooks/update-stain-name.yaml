useCase:
  id: "UPDATE_STAIN_NAME"
  name: "Update Stain Name"
  description: "Update the stain name for a sample, slide, container, or block"
  category: "sample-management"
  version: "1.0"
  downstreamService: "ap-services"
  exampleQuery: "Update stain name for slide [sample_barcode] to [stain_name]"

classification:
  keywords:
    - "update stain name"
    - "update stain"
    - "change stain name"
    - "set stain name"
    - "modify stain name"
    - "stain to"
    - "stain name to"
  synonyms:
    update: ["change", "modify", "set"]
    stain: ["stain name", "stain type"]
    sample: ["slide", "container", "block", "specimen"]
  requiredEntities:
    - barcode
    - stainName

extraction:
  entities:
    barcode:
      type: "string"
      patterns:
        - "(?:sample|slide|container|block)\\s+\\[?([A-Za-z0-9\\-_]{4,50})\\]?\\s+to" # "for slide [barcode] to" or "for slide barcode to"
        - "(?:sample|slide|container|block)\\s+(?:barcode\\s+)?([A-Za-z0-9\\-_]{4,50})" # Alphanumeric barcode with hyphens/underscores
        - "barcode\\s+([A-Za-z0-9\\-_]{4,50})"
        - "(?:for\\s+)?(?:sample|slide|container|block)\\s+([A-Za-z0-9\\-_]{4,50})" # "for slide 2025195T116127-A_1_6"
        - "\\b([A-Za-z0-9]+[\\-_][A-Za-z0-9\\-_]{3,48})\\b" # Barcode with hyphen or underscore (more specific)
      required: true
      validation:
        regex: "^[A-Za-z0-9\\-_]{4,50}$"
        errorMessage: "Barcode must be alphanumeric with optional hyphens/underscores (4-50 characters)"
    
    stainName:
      type: "string"
      patterns:
        - "to\\s+\\[?([A-Za-z0-9\\s\\.\\-]+?)\\]?$" # "to [stain name]" at end of query
        - "to\\s+\\[?([A-Za-z0-9\\s\\.\\-]+?)\\]?(?:\\s*$)" # "to [stain name]" with optional whitespace at end
        - "stain\\s+name\\s+to\\s+\\[?([A-Za-z0-9\\s\\.\\-]+?)\\]?"
        - "stain\\s+to\\s+\\[?([A-Za-z0-9\\s\\.\\-]+?)\\]?"
        - "as\\s+\\[?([A-Za-z0-9\\s\\.\\-]+?)\\]?" # "as Unstained"
      required: true
      validation:
        regex: "^[A-Za-z0-9\\s\\.\\-]{1,100}$"
        errorMessage: "Stain name must be alphanumeric with spaces, dots, or hyphens (1-100 characters)"

execution:
  timeout: 30
  retryPolicy:
    maxAttempts: 3
    backoffMs: 1000
  
  steps:
    # ==================== PRECHECKS ====================
    
    - stepNumber: 1
      stepType: "prechecks"
      name: "Verify User Has Update Permission"
      description: "Check if user has Production Support role"
      autoExecutable: true
      method: "HEADER_CHECK"
      path: "Role-Name"
      expectedResponse: "Production Support"
      stepResponseMessage: "User has sufficient privileges to perform this action: '{role}'"
      stepResponseErrorMessage: "User does not have required role for stain name update"
      errorHandling:
        onFailure: "abort"
        message: "User does not have required role for stain name update"
    
    - stepNumber: 2
      stepType: "prechecks"
      name: "Preview Stain Name Update Impact"
      description: "Display impact message to user"
      autoExecutable: true
      method: "LOCAL_MESSAGE"
      localMessage: "Stain name will be updated to {stainName} for barcode {barcode}. This may affect downstream processes."
      stepResponseMessage: "Stain name will be updated to {stainName} for sample {barcode}. This may affect downstream processes."
      errorHandling:
        onFailure: "continue"
    
    # ==================== PROCEDURE ====================
    
    - stepNumber: 3
      stepType: "procedure"
      name: "Execute Stain Name Update"
      description: "Update the stain name in the system"
      autoExecutable: false
      method: "PATCH"
      path: "/lims-api/samples/{barcode}/stain"
      headers:
        Api-User: "{api_user}"
        Lab-Id: "{lab_id}"
        Discipline-Name: "{discipline_name}"
        Time-Zone: "{time_zone}"
        Role-Name: "{role_name}"
        accept: "application/json"
        Authorization: "Bearer {token}"
        X-User-ID: "{user_id}"
        X-Idempotency-Key: "{IDEMPOTENCY_KEY}"
        Content-Type: "application/json"
      body:
        stainName: "{stainName}"
      expectedStatus: 200
      stepResponseMessage: "Stain name has been successfully updated to {stainName} for sample {barcode}"
      stepResponseErrorMessage: "Failed to update stain name for {barcode}"
      errorHandling:
        onFailure: "abort"
        message: "Failed to update stain name for {barcode}"
    
    # ==================== POSTCHECKS ====================
    
    - stepNumber: 4
      stepType: "postchecks"
      name: "Verify Stain Name Updated"
      description: "Confirm stain name is now {stainName}"
      autoExecutable: true
      method: "GET"
      path: "/lims-api/samples/{barcode}/stain"
      headers:
        Api-User: "{api_user}"
        Lab-Id: "{lab_id}"
        Discipline-Name: "{discipline_name}"
        Time-Zone: "{time_zone}"
        Role-Name: "{role_name}"
        accept: "application/json"
        Authorization: "Bearer {token}"
        X-User-ID: "{user_id}"
      expectedStatus: 200
      expectedResponse: "{stainName}"
      verification:
        expectedFields:
          stainName: "{stainName}"
      stepResponseMessage: "Sample {barcode} stain name is \"{stainName}\""
      stepResponseErrorMessage: "Stain name verification failed for {barcode} and the current stain name is {stainName}"
      errorHandling:
        onFailure: "alert"
        message: "Stain name verification failed for {barcode}"
    
    - stepNumber: 5
      stepType: "postchecks"
      name: "Verify Audit Log Entry Created"
      description: "Check audit log for stain name update event"
      autoExecutable: true
      method: "GET"
      path: "/lims-api/samples/{barcode}/audit-log"
      headers:
        Api-User: "{api_user}"
        Lab-Id: "{lab_id}"
        Discipline-Name: "{discipline_name}"
        Time-Zone: "{time_zone}"
        Role-Name: "{role_name}"
        accept: "application/json"
        Authorization: "Bearer {token}"
        X-User-ID: "{user_id}"
      expectedStatus: 200
      optional: true
      verification:
        requiredFields:
          - "barcode"
          - "stainName"
          - "modifiedBy"
        expectedFields:
          barcode: "{barcode}"
          stainName: "{stainName}"
      stepResponseMessage: "Audit Log entry was created by {modifiedBy} for sample {barcode} and stain name was changed to {stainName}"
      errorHandling:
        onFailure: "continue"
        message: "Could not verify audit log"

rollback:
  enabled: false

warnings:
  - "Stain name updates may affect downstream processes. Please review pre-checks carefully."

metadata:
  author: "Connect Lims Team"
  lastModified: "2025-01-12"
  tags: ["sample-management", "stain-update", "workflow"]
