useCase:
  id: "UPDATE_SAMPLE_STATUS"
  name: "Update Sample Status"
  description: "Update sample, slide, container, or block status following business rules and workflow transitions"
  category: "sample-management"
  version: "1.0"
  downstreamService: "ap-services"
  exampleQuery: "Update sample status for [sample_barcode] to [sample_status]"

classification:
  keywords:
    - "update sample status"
    - "update slide status"
    - "update container status"
    - "update block status"
    - "change sample status"
    - "set sample status"
    - "mark sample status"
    - "status to"
  synonyms:
    update: ["change", "modify", "set", "mark"]
    status: ["state"]
    sample: ["slide", "container", "block", "specimen"]
  requiredEntities:
    - barcode
    - sampleStatus

extraction:
  entities:
    barcode:
      type: "string"
      patterns:
        - "for\\s+\\[?([A-Za-z0-9\\-_]{4,50})\\]?\\s+to" # "for [barcode] to" or "for barcode to"
        - "(?:sample|slide|container|block)\\s+(?:barcode\\s+)?([A-Za-z0-9\\-_]{4,50})" # Alphanumeric barcode with hyphens/underscores
        - "barcode\\s+([A-Za-z0-9\\-_]{4,50})"
        - "(?:for\\s+)?(?:sample|slide|container|block)\\s+([A-Za-z0-9\\-_]{4,50})" # "for sample BC123456" or "for sample 2025268T112913-A_1"
        - "\\b([A-Za-z0-9]+[\\-_][A-Za-z0-9\\-_]{3,48})\\b" # Barcode with hyphen or underscore (more specific than generic pattern)
      required: true
      validation:
        regex: "^[A-Za-z0-9\\-_]{4,50}$"
        errorMessage: "Barcode must be alphanumeric with optional hyphens/underscores (4-50 characters)"
    
    sampleStatus:
      type: "string"
      patterns:
        - "to\\s+\\[?((?:Ready\\s+for|Completed|Hold|In\\s+Process|Canceled|Not\\s+Returned|Microtomy\\s+-\\s+Complete)(?:\\s*-\\s*[A-Za-z\\s]+)?)\\]?" # Handles "to [Completed - Grossing]" or "to Completed - Grossing"
        - "status\\s+to\\s+\\[?((?:Ready\\s+for|Completed|Hold|In\\s+Process|Canceled|Not\\s+Returned|Microtomy\\s+-\\s+Complete)(?:\\s*-\\s*[A-Za-z\\s]+)?)\\]?"
        - "as\\s+\\[?((?:Ready\\s+for|Completed|Hold|In\\s+Process|Canceled|Not\\s+Returned|Microtomy\\s+-\\s+Complete)(?:\\s*-\\s*[A-Za-z\\s]+)?)\\]?"
        - "mark\\s+status\\s+to\\s+\\[?((?:Ready\\s+for|Completed|Hold|In\\s+Process|Canceled|Not\\s+Returned|Microtomy\\s+-\\s+Complete)(?:\\s*-\\s*[A-Za-z\\s]+)?)\\]?"
        - "set\\s+status\\s+to\\s+\\[?((?:Ready\\s+for|Completed|Hold|In\\s+Process|Canceled|Not\\s+Returned|Microtomy\\s+-\\s+Complete)(?:\\s*-\\s*[A-Za-z\\s]+)?)\\]?"
        - "\\[?((?:Ready\\s+for|Completed|Hold|In\\s+Process|Canceled|Not\\s+Returned|Microtomy\\s+-\\s+Complete)(?:\\s*-\\s*[A-Za-z\\s]+)?)\\]?(?:\\s+and\\s+update\\s+workpool)?" # Handles "Completed - Microtomy and update workpool"
      required: true
      validation:
        enumValues:
          - "Canceled"
          - "Completed - Grossing"
          - "Completed - Microtomy"
          - "Completed - Pathologist Review"
          - "Completed - Slide Storage"
          - "Completed - Staining"
          - "Completed - Storage"
          - "Completed - TC Only Sign Out"
          - "Hold - Complete"
          - "Hold - Embedding"
          - "Hold - Explicit Accessioning"
          - "Hold - Grossing"
          - "Hold - Microtomy"
          - "Hold - Not Returned"
          - "Hold - Pathologist Review"
          - "Hold - Processing"
          - "Hold - Sendout"
          - "Hold - Slide Storage"
          - "Hold - Wicking"
          - "In Process - Case Assembly"
          - "In Process - Decalcification"
          - "In Process - Explicit Accessioning"
          - "In Process - Grossing"
          - "In Process - Microtomy"
          - "In Process - Pathologist Review"
          - "In Process - Processing"
          - "In Process - Sendout"
          - "In Process - Staining"
          - "In Process - TC Only Sign Out"
          - "In Process - Wicking"
          - "Microtomy - Complete"
          - "Not Returned"
          - "Ready for - Case Assembly"
          - "Ready for - Embedding"
          - "Ready for - Explicit Accessioning"
          - "Ready for - Grossing"
          - "Ready for - Microtomy"
          - "Ready for - Pathologist Review"
          - "Ready for - Processing"
          - "Ready for - Sendout"
          - "Ready for - Slide Storage"
          - "Ready for - Staining"
          - "Ready for - Storage"
          - "Ready for - TC Only Sign Out"
        errorMessage: "Status must be a valid workflow status"

execution:
  timeout: 30
  retryPolicy:
    maxAttempts: 3
    backoffMs: 1000
  
  steps:
    # ==================== PRECHECKS ====================
    
    - stepNumber: 1
      stepType: "prechecks"
      name: "Verify User Has Update Permission"
      description: "Check if user has Production Support role"
      autoExecutable: true
      method: "HEADER_CHECK"
      path: "Role-Name"
      expectedResponse: "Production Support"
      errorHandling:
        onFailure: "abort"
        message: "User does not have required role for status update"
    
    - stepNumber: 2
      stepType: "prechecks"
      name: "Validate Sample Status"
      description: "Verify that the provided sample status is valid"
      autoExecutable: true
      method: "ENTITY_VALIDATION"
      path: "sampleStatus"
      stepResponseMessage: "Sample status '{sampleStatus}' is valid"
      stepResponseErrorMessage: "Invalid status provided: '{sampleStatus}'. Please provide a valid sample status from the allowed list."
      errorHandling:
        onFailure: "abort"
        message: "Sample status validation failed"
    
    - stepNumber: 3
      stepType: "prechecks"
      name: "Preview Status Update Impact"
      description: "Display impact message to user"
      autoExecutable: true
      method: "LOCAL_MESSAGE"
      localMessage: "Sample status will be updated to {sampleStatus} and workpool updated. This may affect workflow progression."
      errorHandling:
        onFailure: "continue"
    
    # ==================== PROCEDURE ====================
    
    - stepNumber: 4
      stepType: "procedure"
      name: "Execute Sample Status Update"
      description: "Update the sample status in the system"
      autoExecutable: false
      method: "PATCH"
      path: "/lims-api/samples/{barcode}/status"
      headers:
        Api-User: "{api_user}"
        Lab-Id: "{lab_id}"
        Discipline-Name: "{discipline_name}"
        Time-Zone: "{time_zone}"
        Role-Name: "{role_name}"
        accept: "application/json"
        Authorization: "Bearer {token}"
        X-User-ID: "{user_id}"
        X-Idempotency-Key: "{IDEMPOTENCY_KEY}"
        Content-Type: "application/json"
      body:
        sampleStatus: "{sampleStatus}"
      expectedStatus: 200
      errorHandling:
        onFailure: "abort"
        message: "Failed to update sample status for {barcode}"
    
    # ==================== POSTCHECKS ====================
    
    - stepNumber: 5
      stepType: "postchecks"
      name: "Verify Sample Status Updated"
      description: "Confirm sample status is now {sampleStatus}"
      autoExecutable: true
      method: "GET"
      path: "/lims-api/samples/{barcode}/status"
      headers:
        Api-User: "{api_user}"
        Lab-Id: "{lab_id}"
        Discipline-Name: "{discipline_name}"
        Time-Zone: "{time_zone}"
        Role-Name: "{role_name}"
        accept: "application/json"
        Authorization: "Bearer {token}"
        X-User-ID: "{user_id}"
      expectedStatus: 200
      expectedResponse: "{sampleStatus}"
      errorHandling:
        onFailure: "alert"
        message: "Sample status verification failed for {barcode}"
    
    - stepNumber: 6
      stepType: "postchecks"
      name: "Verify Audit Log Entry Created"
      description: "Check audit log for status update event"
      autoExecutable: true
      method: "GET"
      path: "/lims-api/samples/{barcode}/audit-log"
      headers:
        Api-User: "{api_user}"
        Lab-Id: "{lab_id}"
        Discipline-Name: "{discipline_name}"
        Time-Zone: "{time_zone}"
        Role-Name: "{role_name}"
        accept: "application/json"
        Authorization: "Bearer {token}"
        X-User-ID: "{user_id}"
      expectedStatus: 200
      optional: true
      errorHandling:
        onFailure: "continue"
        message: "Could not verify audit log"

rollback:
  enabled: false

warnings:
  - "Sample status updates may affect workflow progression. Please review pre-checks carefully."

metadata:
  author: "Connect Lims Team"
  lastModified: "2024-12-01"
  tags: ["sample-management", "status-update", "workflow"]

