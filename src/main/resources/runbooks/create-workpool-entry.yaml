useCase:
  id: "CREATE_WORKPOOL_ENTRY"
  name: "Create Workpool Entry"
  description: "Create a workpool entry for a sample by barcode"
  category: "sample-management"
  version: "1.0"
  downstreamService: "ap-services"
  exampleQuery: "Create workpool entry [workpool_name] for sample [sample_barcode] with lab code [lab_code]"

classification:
  keywords:
    - "create workpool entry"
    - "create workpool"
    - "add workpool entry"
    - "add workpool"
    - "create entry"
    - "add entry"
  synonyms:
    create: ["add", "new", "insert"]
    workpool: ["workpool entry", "work pool", "work pool entry"]
    sample: ["slide", "container", "block", "specimen"]
  requiredEntities:
    - barcode
    - workpoolName
    - labCode

extraction:
  entities:
    barcode:
      type: "string"
      patterns:
        - "(?:sample|slide|container|block)\\s+(?:barcode\\s+)?([A-Za-z0-9\\-_]{4,50})" # Alphanumeric barcode with hyphens/underscores
        - "barcode\\s+([A-Za-z0-9\\-_]{4,50})"
        - "(?:for\\s+)?(?:sample|slide|container|block)\\s+([A-Za-z0-9\\-_]{4,50})" # "for sample BC123456"
        - "([A-Za-z0-9\\-_]{4,50})" # Standalone barcode
      required: true
      validation:
        regex: "^[A-Za-z0-9\\-_]{4,50}$"
        errorMessage: "Barcode must be alphanumeric with optional hyphens/underscores (4-50 characters)"
    
    workpoolName:
      type: "string"
      patterns:
        - "workpool\\s+entry\\s+([A-Za-z0-9\\-_\\s]+)\\s+for" # "workpool entry NAME for"
        - "workpool\\s+([A-Za-z0-9\\-_\\s]+)\\s+for" # "workpool NAME for"
        - "entry\\s+([A-Za-z0-9\\-_\\s]+)\\s+for" # "entry NAME for"
        - "workpool\\s+entry\\s+([A-Za-z0-9\\-_\\s]+)" # "workpool entry NAME"
        - "workpool\\s+([A-Za-z0-9\\-_\\s]+)" # "workpool NAME"
        - "for\\s+workpool\\s+([A-Za-z0-9\\-_\\s]+)" # "for workpool NAME"
      required: true
      validation:
        regex: "^[A-Za-z0-9\\-_\\s]{1,100}$"
        errorMessage: "Workpool name must be alphanumeric with optional hyphens, underscores, or spaces (1-100 characters)"
    
    labCode:
      type: "string"
      patterns:
        - "lab\\s+code\\s+([A-Za-z0-9\\-_]{2,20})" # "lab code ABC123"
        - "lab\\s+([A-Za-z0-9\\-_]{2,20})" # "lab ABC123"
        - "code\\s+([A-Za-z0-9\\-_]{2,20})" # "code ABC123"
        - "\\b([A-Z]{2,10})\\b" # Standalone uppercase lab code (2-10 chars)
        - "\\b([A-Za-z0-9]{2,20})\\b" # Standalone alphanumeric code
      required: true
      validation:
        regex: "^[A-Za-z0-9\\-_]{2,20}$"
        errorMessage: "Lab code must be alphanumeric with optional hyphens/underscores (2-20 characters)"

execution:
  timeout: 30
  retryPolicy:
    maxAttempts: 3
    backoffMs: 1000
  
  steps:
    # ==================== PRECHECKS ====================
    
    - stepNumber: 1
      stepType: "prechecks"
      name: "Verify User Has Create Permission"
      description: "Check if user has Production Support role"
      autoExecutable: true
      method: "HEADER_CHECK"
      path: "Role-Name"
      expectedResponse: "Production Support"
      stepResponseMessage: "User has sufficient privileges to perform this action: '{role}'"
      stepResponseErrorMessage: "User does not have required role for workpool entry creation"
      errorHandling:
        onFailure: "abort"
        message: "User does not have required role for workpool entry creation"
    
    - stepNumber: 2
      stepType: "prechecks"
      name: "Validate Required Entities"
      description: "Validate that all required entities are provided"
      autoExecutable: true
      method: "ENTITY_VALIDATION"
      path: "labCode"
      stepResponseMessage: "Lab code '{labCode}' is valid"
      stepResponseErrorMessage: "Required entity {labCode} not provided"
      errorHandling:
        onFailure: "abort"
        message: "Lab code is required for workpool entry creation"
    
    - stepNumber: 3
      stepType: "prechecks"
      name: "Preview Workpool Entry Creation Impact"
      description: "Display impact message to user"
      autoExecutable: true
      method: "LOCAL_MESSAGE"
      localMessage: "Workpool entry '{workpoolName}' will be created for barcode {barcode}. This may affect workflow progression."
      stepResponseMessage: "Workpool entry {workpoolName} will be created for sample {barcode}. This may affect workflow progression."
      errorHandling:
        onFailure: "continue"
    
    # ==================== PROCEDURE ====================
    
    - stepNumber: 4
      stepType: "procedure"
      name: "Execute Workpool Entry Creation"
      description: "Create the workpool entry in the system"
      autoExecutable: false
      method: "POST"
      path: "/lims-api/samples/{barcode}/workpool"
      headers:
        Api-User: "{api_user}"
        Lab-Id: "{lab_id}"
        Discipline-Name: "{discipline_name}"
        Time-Zone: "{time_zone}"
        Role-Name: "{role_name}"
        accept: "application/json"
        Authorization: "Bearer {token}"
        X-User-ID: "{user_id}"
        X-Idempotency-Key: "{IDEMPOTENCY_KEY}"
        Content-Type: "application/json"
      body:
        workpoolName: "{workpoolName}"
        labCode: "{labCode}"
      expectedStatus: 201
      stepResponseMessage: "Workpool entry {workpoolName} has been successfully created for sample {barcode}"
      stepResponseErrorMessage: "Failed to create workpool entry {workpoolName} for {barcode}"
      errorHandling:
        onFailure: "abort"
        message: "Failed to create workpool entry {workpoolName} for {barcode}"
    
    # ==================== POSTCHECKS ====================
    
    - stepNumber: 5
      stepType: "postchecks"
      name: "Verify Workpool Entry Created"
      description: "Confirm workpool entry was created successfully"
      autoExecutable: true
      method: "GET"
      path: "/lims-api/samples/{barcode}/workpool"
      headers:
        Api-User: "{api_user}"
        Lab-Id: "{lab_id}"
        Discipline-Name: "{discipline_name}"
        Time-Zone: "{time_zone}"
        Role-Name: "{role_name}"
        accept: "application/json"
        Authorization: "Bearer {token}"
        X-User-ID: "{user_id}"
        Content-Type: "application/json"
      body:
        workpoolName: "{workpoolName}"
        labCode: "{labCode}"
      expectedStatus: 200
      optional: true
      verification:
        requiredFields:
          - "barcode"
          - "workpoolName"
        expectedFields:
          barcode: "{barcode}"
          workpoolName: "{workpoolName}"
      stepResponseMessage: "Workpool entry {workpoolName} verified for sample {barcode}"
      stepResponseErrorMessage: "Could not verify workpool entry {workpoolName} creation for {barcode}"
      errorHandling:
        onFailure: "continue"
        message: "Could not verify workpool entry creation"
    
    - stepNumber: 6
      stepType: "postchecks"
      name: "Verify Audit Log Entry Created"
      description: "Check audit log for workpool entry creation event"
      autoExecutable: true
      method: "GET"
      path: "/lims-api/samples/{barcode}/workpool/audit-log"
      headers:
        Api-User: "{api_user}"
        Lab-Id: "{lab_id}"
        Discipline-Name: "{discipline_name}"
        Time-Zone: "{time_zone}"
        Role-Name: "{role_name}"
        accept: "application/json"
        Authorization: "Bearer {token}"
        X-User-ID: "{user_id}"
      expectedStatus: 200
      optional: true
      verification:
        requiredFields:
          - "barcode"
          - "workpoolName"
          - "modifiedBy"
        expectedFields:
          barcode: "{barcode}"
          workpoolName: "{workpoolName}"
      stepResponseMessage: "Audit Log entry was created by {modifiedBy} for workpool entry {workpoolName} creation for sample {barcode}"
      errorHandling:
        onFailure: "continue"
        message: "Could not verify audit log"

rollback:
  enabled: false

warnings:
  - "Creating workpool entries may affect workflow progression. Please review pre-checks carefully."

metadata:
  author: "Connect Lims Team"
  lastModified: "2025-01-12"
  tags: ["sample-management", "workpool", "create"]
