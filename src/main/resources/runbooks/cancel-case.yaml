useCase:
  id: "CANCEL_CASE"
  name: "Cancel Case"
  description: "Complete cancellation of a case including cleanup of associated workflows"
  category: "case-management"
  version: "3.1"
  downstreamService: "ap-services"
  exampleQuery: "Cancel case [case_number]"

classification:
  keywords:
    - "cancel case"
    - "delete case"
    - "abort case"
    - "remove case"
    - "cancel"
    - "cancellation" 
    - "cancel a case"
  synonyms:
    cancel: ["delete", "abort", "remove", "terminate", "cancellation", "cancel a case"]
    case: ["a case", "the case", "case"]
  requiredEntities:
    - case_id

extraction:
  entities:
    case_id:
      type: "string"
      patterns:
        - "(?:a\\s+|the\\s+)?case\\s+([A-Za-z0-9\\-\\[\\]]+)" # Handles "a case", "the case", or "case" - allows brackets
        - "caseid\\s+([A-Za-z0-9\\-\\[\\]]+)"
        - "case\\s+id\\s+([A-Za-z0-9\\-\\[\\]]+)"
        - "case\\s+number\\s+([A-Za-z0-9\\-\\[\\]]+)"
        - "\\[?(\\d{7,}[A-Z]\\d{4,})\\]?" # Format: optional brackets, 7+ digits + letter + 4+ digits (e.g., [2025251T115466] or 2025251T115466)
        - "(\\d{7,}[A-Z]\\d{4,})" # Format without brackets: 7+ digits + letter + 4+ digits (e.g., 2025251T115466)
      required: true
      validation:
        regex: "^[A-Za-z0-9\\-\\[\\]]{4,}$"
        errorMessage: "Case ID must be alphanumeric with optional brackets, hyphens (4+ characters)"

execution:
  timeout: 30
  retryPolicy:
    maxAttempts: 3
    backoffMs: 1000
  
  steps:
    # ==================== PRECHECKS ====================
    
    - stepNumber: 1
      stepType: "prechecks"
      name: "Verify User Has Cancel Permission"
      description: "Check if user has Production Support role"
      autoExecutable: true
      method: "HEADER_CHECK"
      path: "Role-Name"
      expectedResponse: "Production Support"
      stepResponseMessage: "User has sufficient privileges to perform this action: '{role}'"
      stepResponseErrorMessage: "User does not have required role for cancellation"
      errorHandling:
        onFailure: "abort"
        message: "User does not have required role for cancellation"
    
    - stepNumber: 2
      stepType: "prechecks"
      name: "Preview Cancellation Impact"
      description: "Display impact message to user"
      autoExecutable: true
      method: "LOCAL_MESSAGE"
      localMessage: "Case and it's materials will be canceled and removed from the workpool"
      stepResponseMessage: "Case {case_id} and it's materials will be canceled and removed from the workpool"
      errorHandling:
        onFailure: "continue"
    
    # ==================== PROCEDURE ====================
    
    - stepNumber: 3
      stepType: "procedure"
      name: "Execute Case Cancellation"
      description: "Cancel the case in the system"
      autoExecutable: false
      method: "PATCH"
      path: "/lims-api/case/{case_id}/cancel"
      headers:
        Api-User: "{api_user}"
        Lab-Id: "{lab_id}"
        Discipline-Name: "{discipline_name}"
        Time-Zone: "{time_zone}"
        Role-Name: "{role_name}"
        accept: "application/json"
        Authorization: "Bearer {token}"
        X-User-ID: "{user_id}"
        X-Idempotency-Key: "{IDEMPOTENCY_KEY}"
        Content-Type: "application/json"
      body:
        reason: "operational_request"
        notes: "Cancelled via Production Support"
        notify_stakeholders: true
      expectedStatus: 200
      stepResponseMessage: "Case {case_id} has been successfully canceled"
      stepResponseErrorMessage: "Failed to cancel case {case_id}"
      errorHandling:
        onFailure: "abort"
        message: "Failed to cancel case {case_id}"
    
    # ==================== POSTCHECKS ====================
    
    - stepNumber: 4
      stepType: "postchecks"
      name: "Verify Case Status Updated to Cancelled"
      description: "Confirm case status is now cancelled"
      autoExecutable: true
      method: "GET"
      path: "/lims-api/case/{case_id}/status"
      headers:
        Api-User: "{api_user}"
        Lab-Id: "{lab_id}"
        Discipline-Name: "{discipline_name}"
        Time-Zone: "{time_zone}"
        Role-Name: "{role_name}"
        accept: "application/json"
        Authorization: "Bearer {token}"
        X-User-ID: "{user_id}"
      expectedStatus: 200
      expectedResponse: "cancelled"
      verification:
        expectedFields:
          status: "Canceled"
      stepResponseMessage: "Case status is \"{status}\""
      stepResponseErrorMessage: "Case cancellation verification failed for {case_id} and the current status is {status}"
      errorHandling:
        onFailure: "alert"
        message: "Case cancellation verification failed for {case_id}"
    
    - stepNumber: 5
      stepType: "postchecks"
      name: "Verify Audit Log Entry Created"
      description: "Check audit log for cancellation event"
      autoExecutable: true
      method: "GET"
      path: "/lims-api/case/{case_id}/audit-log"
      headers:
        Api-User: "{api_user}"
        Lab-Id: "{lab_id}"
        Discipline-Name: "{discipline_name}"
        Time-Zone: "{time_zone}"
        Role-Name: "{role_name}"
        accept: "application/json"
        Authorization: "Bearer {token}"
        X-User-ID: "{user_id}"
      expectedStatus: 200
      optional: true
      verification:
        requiredFields:
          - "caseId"
          - "status"
          - "modifiedBy"
        expectedFields:
          caseId: "{case_id}"
          status: "Canceled"
      stepResponseMessage: "Audit Log entry was created by {modifiedBy} for {caseId} and status was changed to {status}"
      errorHandling:
        onFailure: "continue"
        message: "Could not verify audit log"

rollback:
  enabled: false

warnings:
  - "Case cancellation is a critical operation. Please review pre-checks carefully."

metadata:
  author: "Connect Lims Team"
  lastModified: "2024-12-01"
  tags: ["case-management", "cancellation", "critical"]

